{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/metyatech/agent-runner/schema/agent-runner.schema.json",
  "title": "Agent Runner Configuration",
  "type": "object",
  "required": ["owner", "workdirRoot", "pollIntervalSeconds", "concurrency", "labels", "codex"],
  "properties": {
    "owner": {
      "type": "string",
      "minLength": 1
    },
    "repos": {
      "oneOf": [
        { "type": "string", "enum": ["all"] },
        {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        }
      ]
    },
    "workdirRoot": {
      "type": "string",
      "minLength": 1
    },
    "pollIntervalSeconds": {
      "type": "integer",
      "minimum": 10,
      "maximum": 3600
    },
    "concurrency": {
      "type": "integer",
      "minimum": 1,
      "maximum": 16
    },
    "serviceConcurrency": {
      "type": "object",
      "properties": {
        "codex": { "type": "integer", "minimum": 1, "maximum": 16 },
        "copilot": { "type": "integer", "minimum": 1, "maximum": 16 },
        "gemini": { "type": "integer", "minimum": 1, "maximum": 16 },
        "amazonQ": { "type": "integer", "minimum": 1, "maximum": 16 },
        "claude": { "type": "integer", "minimum": 1, "maximum": 16 }
      },
      "additionalProperties": false
    },
    "logMaintenance": {
      "type": "object",
      "required": ["enabled"],
      "properties": {
        "enabled": { "type": "boolean" },
        "maxAgeDays": { "type": "integer", "minimum": 0, "maximum": 3650 },
        "keepLatest": { "type": "integer", "minimum": 0, "maximum": 100000 },
        "maxTotalMB": { "type": "number", "minimum": 0, "maximum": 1048576 },
        "taskRunKeepLatest": { "type": "integer", "minimum": 0, "maximum": 100000 },
        "writeLatestPointers": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "reportMaintenance": {
      "type": "object",
      "required": ["enabled"],
      "properties": {
        "enabled": { "type": "boolean" },
        "maxAgeDays": { "type": "integer", "minimum": 0, "maximum": 3650 },
        "keepLatest": { "type": "integer", "minimum": 0, "maximum": 100000 },
        "maxTotalMB": { "type": "number", "minimum": 0, "maximum": 1048576 }
      },
      "additionalProperties": false
    },
    "amazonQ": {
      "type": "object",
      "required": ["enabled", "command", "args"],
      "properties": {
        "enabled": { "type": "boolean" },
        "command": { "type": "string", "minLength": 1 },
        "args": { "type": "array", "items": { "type": "string" } },
        "promptMode": { "type": "string", "enum": ["stdin", "arg"] }
      },
      "additionalProperties": false
    },
    "claude": {
      "type": "object",
      "required": ["enabled", "command", "args"],
      "properties": {
        "enabled": { "type": "boolean" },
        "command": { "type": "string", "minLength": 1 },
        "args": { "type": "array", "items": { "type": "string" } },
        "promptMode": { "type": "string", "enum": ["arg", "stdin"] }
      },
      "additionalProperties": false
    },
    "idle": {
      "type": "object",
      "required": ["enabled", "maxRunsPerCycle", "cooldownMinutes", "tasks", "promptTemplate"],
      "properties": {
        "enabled": { "type": "boolean" },
        "maxRunsPerCycle": { "type": "integer", "minimum": 1, "maximum": 16 },
        "cooldownMinutes": { "type": "integer", "minimum": 0, "maximum": 10080 },
        "tasks": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        },
        "promptTemplate": { "type": "string", "minLength": 1 },
        "repoScope": { "type": "string", "enum": ["all", "local"] },
        "usageGate": {
          "type": "object",
          "required": [
            "enabled",
            "command",
            "args",
            "timeoutSeconds",
            "minRemainingPercent",
            "weeklySchedule"
          ],
          "properties": {
            "enabled": { "type": "boolean" },
            "command": { "type": "string", "minLength": 1 },
            "args": {
              "type": "array",
              "items": { "type": "string" }
            },
            "timeoutSeconds": { "type": "integer", "minimum": 1, "maximum": 120 },
            "minRemainingPercent": {
              "type": "object",
              "required": ["fiveHour"],
              "properties": {
                "fiveHour": { "type": "number", "minimum": 0, "maximum": 100 }
              },
              "additionalProperties": false
            },
            "weeklySchedule": {
              "type": "object",
              "required": [
                "startMinutes",
                "minRemainingPercentAtStart",
                "minRemainingPercentAtEnd"
              ],
              "properties": {
                "startMinutes": { "type": "integer", "minimum": 0, "maximum": 10080 },
                "minRemainingPercentAtStart": { "type": "number", "minimum": 0, "maximum": 100 },
                "minRemainingPercentAtEnd": { "type": "number", "minimum": 0, "maximum": 100 }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        },
        "copilotUsageGate": {
          "type": "object",
          "required": ["enabled", "timeoutSeconds", "monthlySchedule"],
          "properties": {
            "enabled": { "type": "boolean" },
            "timeoutSeconds": { "type": "integer", "minimum": 1, "maximum": 120 },
            "apiBaseUrl": { "type": "string", "minLength": 1 },
            "apiVersion": { "type": "string", "minLength": 1 },
            "monthlySchedule": {
              "type": "object",
              "required": [
                "startMinutes",
                "minRemainingPercentAtStart",
                "minRemainingPercentAtEnd"
              ],
              "properties": {
                "startMinutes": { "type": "integer", "minimum": 0, "maximum": 525600 },
                "minRemainingPercentAtStart": { "type": "number", "minimum": 0, "maximum": 100 },
                "minRemainingPercentAtEnd": { "type": "number", "minimum": 0, "maximum": 100 }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        },
        "geminiUsageGate": {
          "type": "object",
          "required": [
            "enabled",
            "strategy",
            "startMinutes",
            "minRemainingPercentAtStart",
            "minRemainingPercentAtEnd"
          ],
          "properties": {
            "enabled": { "type": "boolean" },
            "strategy": { "type": "string", "enum": ["spare-only"] },
            "warmup": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "cooldownMinutes": { "type": "integer", "minimum": 0, "maximum": 10080 }
              },
              "additionalProperties": false
            },
            "startMinutes": { "type": "integer", "minimum": 0, "maximum": 10080 },
            "minRemainingPercentAtStart": { "type": "number", "minimum": 0, "maximum": 100 },
            "minRemainingPercentAtEnd": { "type": "number", "minimum": 0, "maximum": 100 }
          },
          "additionalProperties": false
        },
        "amazonQUsageGate": {
          "type": "object",
          "required": ["enabled", "monthlyLimit", "monthlySchedule"],
          "properties": {
            "enabled": { "type": "boolean" },
            "monthlyLimit": { "type": "integer", "minimum": 1, "maximum": 1000000 },
            "monthlySchedule": {
              "type": "object",
              "required": [
                "startMinutes",
                "minRemainingPercentAtStart",
                "minRemainingPercentAtEnd"
              ],
              "properties": {
                "startMinutes": { "type": "integer", "minimum": 0, "maximum": 525600 },
                "minRemainingPercentAtStart": { "type": "number", "minimum": 0, "maximum": 100 },
                "minRemainingPercentAtEnd": { "type": "number", "minimum": 0, "maximum": 100 }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        },
        "claudeUsageGate": {
          "type": "object",
          "required": ["enabled", "monthlyLimit", "monthlySchedule"],
          "properties": {
            "enabled": { "type": "boolean" },
            "monthlyLimit": { "type": "integer", "minimum": 1, "maximum": 1000000 },
            "monthlySchedule": {
              "type": "object",
              "required": [
                "startMinutes",
                "minRemainingPercentAtStart",
                "minRemainingPercentAtEnd"
              ],
              "properties": {
                "startMinutes": { "type": "integer", "minimum": 0, "maximum": 525600 },
                "minRemainingPercentAtStart": { "type": "number", "minimum": 0, "maximum": 100 },
                "minRemainingPercentAtEnd": { "type": "number", "minimum": 0, "maximum": 100 }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "labels": {
      "type": "object",
      "required": ["queued", "running", "done", "failed", "needsUserReply", "reviewFollowup"],
      "properties": {
        "queued": { "type": "string", "minLength": 1 },
        "running": { "type": "string", "minLength": 1 },
        "done": { "type": "string", "minLength": 1 },
        "failed": { "type": "string", "minLength": 1 },
        "needsUserReply": { "type": "string", "minLength": 1 },
        "reviewFollowup": { "type": "string", "minLength": 1 },
        "reviewFollowupWaiting": { "type": "string", "minLength": 1 },
        "reviewFollowupActionRequired": { "type": "string", "minLength": 1 }
      },
      "additionalProperties": false
    },
    "codex": {
      "type": "object",
      "required": ["command", "args", "promptTemplate"],
      "properties": {
        "command": { "type": "string", "minLength": 1 },
        "args": {
          "type": "array",
          "items": { "type": "string" }
        },
        "promptTemplate": { "type": "string", "minLength": 1 }
      },
      "additionalProperties": false
    },
    "gemini": {
      "type": "object",
      "required": ["command", "args"],
      "properties": {
        "command": { "type": "string", "minLength": 1 },
        "args": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": false
    },
    "webhooks": {
      "type": "object",
      "required": ["enabled", "host", "port", "path"],
      "properties": {
        "enabled": { "type": "boolean" },
        "host": { "type": "string", "minLength": 1 },
        "port": { "type": "integer", "minimum": 1, "maximum": 65535 },
        "path": { "type": "string", "minLength": 1 },
        "secret": { "type": "string", "minLength": 1 },
        "secretEnv": { "type": "string", "minLength": 1 },
        "maxPayloadBytes": { "type": "integer", "minimum": 1024, "maximum": 10485760 },
        "queueFile": { "type": "string", "minLength": 1 },
        "catchup": {
          "type": "object",
          "required": ["enabled", "intervalMinutes", "maxIssuesPerRun"],
          "properties": {
            "enabled": { "type": "boolean" },
            "intervalMinutes": { "type": "integer", "minimum": 1, "maximum": 10080 },
            "maxIssuesPerRun": { "type": "integer", "minimum": 1, "maximum": 200 }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "copilot": {
      "type": "object",
      "required": ["command", "args"],
      "properties": {
        "command": { "type": "string", "minLength": 1 },
        "args": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}

